AWS에 node.js 서버 배포하기

하는이유 - 터미널열고 서버돌리면 서버운영은 가능하나
하루죙일 켜놓을 수 없기에 안전하게 클라우드 서비스를 컴퓨터를 빌려서 
서버를 띄움

AWS Elastic Beanstalk 사용

AWS에서 EC2상품이 제일 유명한데 숙련자가 아니면 사용이 힘들다고함

그래서 보통 편하게 하려면 Elastic Beanstalk 사용하면 된다고함
코드만 올리면 알아서 인스톨하고 알아서 서버연결 해준다고함

새계정파고 카드등록하면 1년 저사양컴퓨터 빌려준다고함.

배포전 체크할것

현재 몽고디비 호스팅을 받아 사용하고 있는데
AWS 컴퓨터도 몽고디비에 접속해서 데이터를 꺼낼 수 있게 만들어야 함

몽고디비 > 좌측 Network access 메뉴에서
접속가능 IP를 0.0.0.0 으로해서 모든IP에서 접속가능하게 변경
더 안전한 방법을 원한다면 AWS VPC로 몽고디비 atlas연결하는법을 찾아서 적용

배포하려면!

1. 소스코드를 zip으로 묶어야함
! 노드모듈, 깃어쩌구 이런거 제외
! env파일은 넣는다.

2. AWS로그인하고 카드등록하고
로그인하면 우측 상단에 지역선택 서울에서 하기에 서울로 설정

3. IAM 역할 만들기
AWS사이트 들어가서 상단 검색창에 IAM검색

좌측메뉴의 역할 눌렀을때
aws-elasticbeanstalk-ec2-role 역할 이름이 없다면 역할 만들기 누름
elastic beanstalk이 ec2 맘대로 사용할 수 있게 만드는 부분이다.

(1) 신뢰할 수 있는 엔터티는 AWS서비스, 사용사례는 EC2선택
(2) 권한추가 메뉴에서는 
AWSElasticBeanstalkWebTier
AWSElasticBeanstalkWorkerTier
AWSElasticBeanstalkMulticontainerDocker
위 3개 찾아서 체크마크
(3)  이름 지정부분은 
aws-elasticbeanstalk-ec2-role 정확히 기입하고 마무리. 
Elastic beanstalk 처음 만들 때 IAM 설정은 알아서 해주는데
버그로 안해줄때가 있어서 직접해야한다고 한다.
 
4. Elastic beanstalk

AWS사이트 상단 검색창에 Elastic beanstalk 검색해서 들어감
앱생성이나 환경생성 버튼 어딘가에 있는거 눌러서 진행

(1) 이거저거 적으라고 나올것
애플리케이션이름 : 아무거나 작명
환경이름 : 잘 작명
플랫폼 : nodejs 18version or 우리가 쓰는 버전
프리셋 : 단일인스턴스 (가난하기에...)
코드업로드 눌러서 위에서 압축한 zip파일 올리기
버전레이블은 소스코드 버전 기록용이다.
이쁘게 작성하면 좋을듯 ex) version1.0

(2) 서비스 액세스 구성
서비스역할 - 기존서비스역할사용
aws-elasticbeanstalk-service-role 되어있는지
EC2 인스턴스 프로파일
aws-elasticbeanstalk-ec2-role
잘되어있으면 된것
안되어있다면 IAM설정이 잘못되어있는것

(3) 건드릴 필요없음

(4) 인스턴스유형 - t2.micro가 프리티어에서 쓸 수 있는 기기라서 그걸로 설정
돈내고 빠른걸 원하면 더 상위사양 + 여러 인스턴스를 설정
간혹 배포가 이상하게 되면 램부족 이슈일 수 있고 t2.small이상으로 사용
나머지는 건드릴필요 x

몇분 기다리면 어쩌구.com 주소가 뜨며 그게 만든주소 
-1년넘게 냅두면 요금나올수 있으니 안쓰는 환경삭제 ㄱㄱ
-AWS검색창에 S3입력해서 거기 있는 데이터 백업본도 삭제해야 요금으로부터 안전!
-이미 배포된 프로젝트의 .env 환경변수를 수정하려면 환경 눌러서 설정부분 눌러봄
-구성 메뉴에서 환경설정이가능
-로그 메뉴에선 터미널 로그출력이 가능
-상태 메뉴에선 인스턴스 안쓰는게 있으면 끄고 재부팅하고 그럴 수 있다
인스턴스는 가상 컴퓨터 한대이다.
-모니터링을 자동으로 해줌 400,500 에러 잦거나 접속 잘안될때 알려준다고함
-환경마다 하나의application을 실행할수있고 application은 프로젝트버전1개라고 생각하면됨
-실제서버는 2개의 인스턴스를 띄워놓고 하나다 다운되면 다른 하나로 응대하는 식을 한다고함
메모리이슈문제로 가끔 서버가 다운될수 있다.
혹은 재시작 조건같은걸 설정 할 수 있는 pm2라는 라이브러리가 있다.

- 끝 -

Q. 사이트 업데이트
ㄴ 업로드 및 배포 버튼 눌서서 또 코드zip묶어서 업로드하면됨
단! 새로 생성은 요금이 안나오나 재배포를 너무 자주하면 요금이 청구될 수 있다.

Q. 배포시 이상한 AWS elastic beanstalk 100% 어쩌구뜸
ㄴ 메인페이지접속불가시 그렇다.
보통 DB접속 셋팅불량으로 그런경우가 많다고함

Q. 배포시 안되어서 로그출력해보니 npm ENOMEM나오는데..
ㄴ 램부족이라 인스턴스 사양을 t2.small 이상으로 수정해야한다.

Q. The instance profile ... 어쩌구 없대요
ㄴ IAM 역할이 잘못되어서 그럴듯 다시 셋팅

